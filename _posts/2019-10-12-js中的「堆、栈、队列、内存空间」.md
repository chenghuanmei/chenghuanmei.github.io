---
layout:     post
title:      JS中的堆、栈、队列和内存空间
subtitle:   
date:       2019-10-12
author:     BY
header-img: img/home-bg-o.jpg
catalog: true
tags:
    - JS 
---


## JavaScript 的三种数据结构(表示的是一种数据存储方式)

**Heap (堆)，stack（栈），queue（队列)** 

### stack: LIFO  (last In ， first out)
> 使用场景 **(当我们遇到栈的时候，可能是不同的栈.)**

栈是一种数据结构，表达的是一种数据存储方式，这是一种理论基础。

栈可以用来规定代码的执行顺序，在JavaScript中叫做函数调用栈（call stack）,他是根据栈数据结论理论的一种实践。

栈表达的是一种数据在内存中的储存区域，通常叫做栈区。但是JavaScript并没有像别的语言那样区分栈区和堆区。因此这里就不做扩展。我们可以简单粗暴的认为在JavaScript中，所有的数据都是存放在堆内存空间中的。

### heap
堆结构是一种树状结构，它的存取数据发方法，则与书与书架非常相似。好比在JSON数据中，我们存储的'key-value'是无序的，因为顺序的不同并不影响我们的使用，我们只需要关心书的名字。

### queue: FIFO (fist In , first out) 
队列是一种先进先出（FIFO）的数据结构。正如排队过安检一样，排在队伍前面的人一定是最先过检的人。用以下的图示可以清楚的理解队列的原理。

![](https://user-gold-cdn.xitu.io/2017/11/11/5d0653fff3ec904dbe210161f3ec9196?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

## 变量对象与基本数据类型
JavaScript 的执行上下文生成之后，会创建一个叫做变量对象的特殊对象，JavaScript 的基础数据类型往往都会保存在变量对象中。

严格意义上来说。变量对象也是存储在堆内存中的，由于变量对象的特殊职能，我们理解的时候仍然将其与堆内存区分开。

JS中的基础数据类型，这些值都有固定的大小，往往都保存在栈内存中（闭包除外：闭包中的变量在堆内存中（内存空间管理<垃圾回收机制>）），由系统自动分配存储空间。我们可以直接操作保存在栈内存空间的值，因此基础数据类型都是按值访问 。

JS的引用数据类型，比如数组Array，它们值的大小是不固定的。引用数据类型的值是保存在堆内存中的对象。JS不允许直接访问堆内存中的位置，因此我们不能直接操作对象的堆内存空间。在操作对象时，实际上是在操作对象的引用而不是实际的对象。

因此，引用类型的值都是按引用访问的。这里的引用，我们可以粗浅地理解为保存在栈内存中的一个地址，该地址与堆内存的实际值相关联。

**函数传参数是按值传递？按引用传递？**
>函数调用时，会对参数赋值。而参数传递过程其实同样是变量复制的过程，所以它是按值传递。

## 内存空间管理
> 内存空间管理

### JavaScript执行过程中内存分配：
为变量对象分配需要的内存
在分配到的内存中进行读/写操作
不再使用时将其销毁，释放内存

*内存管理不善，会出现内存泄露，造成浏览器内存占用过多，页面卡顿等问题*

### 垃圾回收机制

JavaScript中有自动垃圾回收机制，会通过标记清除的算法识别哪些变量对象不再使用，对其进行销毁。开发者也可在代码中手动设置变量值为null（a = null）进行标记清除，让其失去引用，以便下一次垃圾回收时进行有效回收。

局部环境中，函数执行完成后，函数局部环境声明的变量不再需要时，就会被垃圾回收销毁（理想的情况下，闭包会阻止这一过程）。

全局环境只有页面退出时才会出栈，解除变量引用。所以开发者应尽量避免在全局环境中创建全局变量，如需使用，也要在不需要时手动标记清除，将其内存释放掉。

### 为什么会有栈内存和堆内存之分？

通常与垃圾回收机制有关。为了使程序运行时占用的内存最小。

当一个方法执行时，每个方法都会建立自己的内存栈，在这个方法内定义的变量将会逐个放入这块栈内存里，随着方法的执行结束，这个方法的内存栈也将自然销毁了。因此，所有在方法中定义的变量都是放在栈内存中的；

当我们在程序中创建一个对象时，这个对象将被保存到运行时数据区中，以便反复利用（因为对象的创建成本通常较大），这个运行时数据区就是堆内存。

堆内存中的对象不会随方法的结束而销毁，即使方法结束后，这个对象还可能被另一个引用变量所引用（方法的参数传递时很常见），则这个对象依然不会被销毁，只有当一个对象没有任何引用变量引用它时，系统的垃圾回收机制才会在核实的时候回收它。

> 关键词：兵乓球盒（栈）、书架取书（堆）、排队进站(队列)

##### Event loop（事件循环）: Event loop basic job is to look both at the stack and the task queue, pushing the first thing on the queue to the stack when it see stack as empty.



### 参考 
- [[译]JavaScript 如何工作：对引擎、运行时、调用堆栈的概述](https://juejin.im/post/5a05b4576fb9a04519690d42)
- [前端基础进阶（一）：内存空间详细图解](https://www.jianshu.com/p/996671d4dcc4)
